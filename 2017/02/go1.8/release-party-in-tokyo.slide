Hot-deploying in Go

Go 1.8 Release Party in Tokyo
16 Feb 2017
Tags: golang, graceful, hot-deploy

Masaki ISHIYAMA
Mercari, Inc
# b4b4r07 gmail.com
http://tellme.tokyo/
@b4b4r07

* Profile

.image img/icon.jpg 200 _

- [[https://github.com/b4b4r07][*@b4b4r07*]], a.k.a. BABAROT
- *'15/4*: Go で CLI ツールなどを書きはじめる
- *'16/4*: 新卒一期としてメルカリにジョイン
-          サーバサイドエンジニア (PHP)
- *'16/8*: SRE 研修 (1ヶ月) にて API Gateway を書く (Go)

* Softwares in Go

CLI ツールなど．

- [[https://github.com/b4b4r07/zsh-history][zsh-history]] - A plugin for zsh history extended by golang, dealing it like SQL
- [[https://github.com/b4b4r07/gomi][gomi]] - A simple trash tool that works on CLI, written in golang
- [[https://github.com/b4b4r07/twistd][twistd]] - Twitter Streaming daemon
- [[https://github.com/search?utf8=%E2%9C%93&q=user%3Ab4b4r07+language%3Ago+-bot&type=Repositories&ref=searchresults][*-bot]] - Slack bot
- etc...

ブログなども書いてるのでよかったら見てみてください．

* Hot-deploying in Go - プロダクションでの実例

* Timeline

- SRE 研修，メンター [[https://github.com/kazeburo][@kazeburo]] さん
- 研修の中盤ごろから Go 製の API Gateway を触る
- サービスインの二歩手前 (このときは，[[https://revel.github.io/][Revel]] を使用)
- 本格稼働に向けてホットデプロイ対応させたい
- [[https://github.com/lestrrat/go-server-starter][lestrrat/go-server-starter]] を使う
- ついでに WAF を使わずに `net/http` で書き直す
- Go 1.8 で Graceful shutdown がサポートされる ([[https://github.com/golang/go/issues/4674][#4674]])

* Dolphin

* Dolphin

Dolphin (API Gateway) とは，

- 便宜上，イルカと呼ぶ🐬
- Revel で書かれていた
- 別の新卒 (同様に SRE 研修) によってつくられた
- そのまま引き継ぎ，BASIC 認証機能やクエリのチューニングを加えた
- そして，デプロイ ... 🚀
- あたらしい機能 P-R したけど，アレ...

(Revel って Graceful shutdown できるの...?)

* Dolphin

Revel...

- [[https://github.com/revel/revel/pull/690][Support zero downtime restarts #690]]
- [[https://github.com/revel/revel/pull/765][Revert "Support zero downtime restarts" #765]]

(今となってはできるよう)

* Dolphin

まず，

- メインサービスの API から呼ばれる関係上，ホットデプロイできるようにしたい
- 要件的に Revel ほど高機能な WAF は必要なかった
- `net/http` で同機能のモックアップ作ってベンチを取ったら倍になってた

以下のベンチマーク結果: (ローカルマシンで計測)

    $ ab -n 10000 -c 1

.image img/benchmark.png 150 _

あとは，ホットデプロイ対応...

* Hot-deploying

* Hot-deploying

# Hot-deployable services are those which can be added to or removed from the running server.
# It is the ability to change ON-THE-FLY what's currently deployed without redeploying it.

ホットデプロイとは，

- fmfm

* lestrrat/go-server-starter

* lestrrat/go-server-starter

イルカさん，対応した 🐬

.image img/kazeburo.png 450 _

* Go graceful shutdown

* BTW,

ホットデプロイ対応のついでに WAF をやめた話は以下にまとめています．

.image img/blog.png 400 _

[[http://tech.mercari.com/entry/2016/12/19/180000][http://tech.mercari.com/entry/2016/12/19/180000]]

* まとめ
